%% Clear/close all
clear all;
close all;

%% Variables de l'interface utilisateur

%temps d'affichage du message d'erreur
tps=2;

%dimension de la boite de dialogue
lg=300;
ht=375;

%logos de l'ENSIM et MERITE
logo1=imread('ensim.png');
logo2=imread('merite.png');

%% Boucle principale
while 1
    %Boite de dialogue principale
    %creation de la boite de dialogue
    main=dialog('Position',[0 0 lg ht],'Name','Traitement','Color',[1 1 1]);
    %centrer la boite de dialogue
    movegui(main,'center');
    %bouton pour ouvrir le fichier
    uicontrol('Parent',main,'Position',[0.25*lg 290 150 25],'String','Ouvrir un fichier .csv','Callback','[filename,pathname,filterindex] = uigetfile(''*.csv'',''Veuillez choisir le fichier .csv'');uiresume(main);','BackgroundColor',[1 1 1]);%bouton ouvrir fichier
    %bouton quitter le programme
    uicontrol('Parent',main,'Position',[0.25*lg 10 150 25],'String','Quitter le programme','Callback','close all;exit;','BackgroundColor',[1 1 1]);
    %attend une action de l'utilisateur
    uiwait(main)
    %Message d'erreur si le fichier n'est pas au bon format
    while filterindex~=1
        %affichage du message
        uicontrol('Parent',main,'Style','text','Position',[0.25*lg 255 150 25],'String','Fichier invalide','BackgroundColor',[1 1 1],'ForegroundColor',[1 0 0]);
        pause(tps);
        %suppression du message
        uicontrol('Parent',main,'Style','text','Position',[0.25*lg 255 150 25],'String','','BackgroundColor',[1 1 1]);
        %redemande d'ouverture du fichier
        [filename,pathname,filterindex] = uigetfile('*.csv','Veuillez choisir le fichier .csv');
    end
    %definit le dossier courant comme etant le dossier dans lequel se trouve le fichier
    cd(pathname);
    % Message d'information du debut du traitement
    uicontrol('Parent',main,'Style','text','Position',[0.25*lg 220 150 25],'String','Traitement en cours...','BackgroundColor',[1 1 1]);
    %lecture des donnees contenus dans le fichier
    
    M=csvread(filename,1,0);
    %% RECUPERATION DES VARIABLES
    %definit la taille de toutes les donnees
    taille=length(M);
    temps=M(:,1);
    declanchement=0;
    accx=M(:,2)*9.81;%changement des valeurs en g vers m/s^2
    accy=M(:,3)*9.81;%changement des valeurs en g vers m/s^2
    accz=M(:,4)*9.81;%changement des valeurs en g vers m/s^2
    gyrox=M(:,5);
    gyroy=M(:,6);
    gyroz=M(:,7);
    alt_p=M(:,8);
    %% RECADRAGE TEMPOREL
    %Detection lancement
    for i=1:taille
        if declanchement==0 && abs(accx(i))>30 && temps(i)>2
            declanchement=1;
            ideclanchement=i-33;%33 car 33Hz de frequency rate
        end
    end
    %Declaration fin de prise de donnee
    ifin=taille-2;%car probleme de zero a la fin
    %Definition de la nouvelle taille de l'intervalle
    taille2=ifin-ideclanchement+1;
    %Preallocation 
    temps2=zeros(1,taille2);
    accx2=zeros(1,taille2);
    accy2=zeros(1,taille2);
    accz2=zeros(1,taille2);
    gyrox2=zeros(1,taille2);
    gyroy2=zeros(1,taille2);
    gyroz2=zeros(1,taille2);
    for i=ideclanchement:ifin
        temps2(i-ideclanchement+1)=temps(i)-temps(ideclanchement);
        accx2(i-ideclanchement+1)=accx(i);
        accy2(i-ideclanchement+1)=accy(i);
        accz2(i-ideclanchement+1)=accz(i);
        gyrox2(i-ideclanchement+1)=gyrox(i);
        gyroy2(i-ideclanchement+1)=gyroy(i);
        gyroz2(i-ideclanchement+1)=gyroz(i);   
    end
    %% SUPPRESSION OFFSET
    %Creation variable temps de 2s pour le calcul offset
    for i=1:taille
        if temps(i)>2
            temps2s=i;
            break
        end
    end
    % Calcul de la moyenne acceleration
    moyaccx=0;
    moyaccy=0;
    moyaccz=0;
    for i=1:temps2s
    moyaccx=moyaccx+accx(i);
    moyaccy=moyaccy+accy(i);
    moyaccz=moyaccz+accz(i);
    end
    moyaccx=moyaccx/temps2s;
    moyaccy=moyaccy/temps2s;
    moyaccz=moyaccz/temps2s;
    % Retranchement des moyennes
    ecart_x=9.81-moyaccx;
    accx2=accx2+ecart_x;
    accy2=accy2-moyaccy;
    accz2=accz2-moyaccz;
    % Mise a 0 des variables y et z
    accx2(1)=9.81;
    accy2(1)=0;
    accz2(1)=0;
    %Calcul de la moyenne gyro
    gyroxmoy=0;
    gyroymoy=0;
    gyrozmoy=0;
    for i=1:temps2s
        gyroxmoy=gyroxmoy+gyrox(i);
        gyroymoy=gyroymoy+gyroy(i);
        gyrozmoy=gyrozmoy+gyroz(i);
    end
    gyroxmoy=gyroxmoy/temps2s;
    gyroymoy=gyroymoy/temps2s;
    gyrozmoy=gyrozmoy/temps2s;
    % Retranchement des moyennes
    gyrox2=gyrox2-gyroxmoy;
    gyroy2=gyroy2-gyroymoy;
    gyroz2=gyroz2-gyrozmoy;
    % Mise a 0 des variables y et z
    gyrox2(1)=0;
    gyroy2(1)=0;
    gyroz2(1)=0;
    %% LISSAGE COURBE
    for i=1:taille2-1
        if abs(accx2(i)-accx2(i+1))<5
            accx2(i+1)=accx2(i);
        end
        if abs(accy2(i)-accy2(i+1))<5
            accy2(i+1)=accy2(i);
        end
         if abs(accz2(i)-accz2(i+1))<5
            accz2(i+1)=accz2(i);
         end
        if abs(gyrox2(i)-gyrox2(i+1))<1
            gyrox2(i+1)=gyrox2(i);
        end
        if abs(gyroy2(i)-gyroy2(i+1))<1
            gyroy2(i+1)=gyroy2(i);
        end
        if abs(gyroz2(i)-gyroz2(i+1))<1
            gyroz2(i+1)=gyroz2(i);
        end
    end
    %% INTEGRATION ANGLE
    angley2=zeros(1,taille2);
    angley2(1)=0;
    for i=2:taille2
        angley2(i)=angley2(i-1)+(temps2(i)-temps2(i-1))*(gyroy2(i)+gyroy2(i-1))/2;  
    end
    anglez2=zeros(1,taille2);
    anglez2(1)=0;
    for i=2:taille2
        anglez2(i)=anglez2(i-1)+(temps2(i)-temps2(i-1))*(gyroz2(i)+gyroz2(i-1))/2;
    end
    anglex2=zeros(1,taille2);
    anglex2(1)=0;
    for i=2:taille2
        anglex2(i)=anglex2(i-1)+(temps2(i)-temps2(i-1))*(gyrox2(i)+gyrox2(i-1))/2;
    end
    %% PROJECTION SUR AXE
    A=cosd(angley2);
    B=-sind(angley2);
    C=cosd(anglex2);
    D=-sind(anglex2);
    E=cosd(anglez2);
    F=sind(anglez2);
    accxh=(B.*D.*E+A.*F).*(-(accy2))+(-B.*D.*F+A.*E).*((-accx2))+(-B.*C).*((accz2))+9.81;
    accxh(1)=0;  
    %% LISSAGE ACCELERATION EN H  
    for i=1:taille2-1
        if abs(accxh(i)-accxh(i+1))<0.5
            accxh(i+1)=accxh(i);
        end
    end
    %% INTEGRATION ACCELERATION EN H
    v=zeros(1,taille2);
    v(1)=0;
    for i=2:taille2
        v(i)=v(i-1)+(temps2(i)-temps2(i-1))*(accxh(i)+accxh(i-1))/2;
    end
    % Integration trapeze pour la position
    p=zeros(1,taille2);
    p(1)=0;
    for i=2:taille2
        p(i)=p(i-1)+(temps2(i)-temps2(i-1))*(v(i)+v(i-1))/2;
    end
    %% AFFICHAGE COURBE
    maxp=cat(2,num2str(round(max(p),1)),' m');
    uicontrol('Parent',main,'Style','text','Position',[0.25*lg 185 150 25],'String',cat(2,{'Altitude maximum : '},maxp),'BackgroundColor',[1 1 1]);
    uicontrol('Parent',main,'Position',[0.25*lg 150 150 25],'String','Afficher le graphique','Callback','fig=figure(''Name'',''Courbes'',''Color'',[1 1 1],''NumberTitle'',''off'');plot(temps2,accxh,temps2,v,temps2,p);xlabel(''temps en s'');legend(''Acceleration en m/s^2'',''Vitesse en m/s'',''Position en m'');grid on;movegui(fig,''center'');','BackgroundColor',[1 1 1]);
    %% Definition du nouveau nom de fichier
    filename=strrep(filename,'.CSV','');
    filename=strcat(filename,'_traite.csv');
    %% Choix du dossier d'enregistrement
    uicontrol('Parent',main,'Style','text','Position',[0.25*lg 220 150 25],'String','Traitement termine','BackgroundColor',[1 1 1],'ForegroundColor',[0 0.5 0]);
    uicontrol('Parent',main,'Position',[0.25*lg 115 150 25],'String','Enregistrer le fichier modifie','Callback','[filename2,pathname2,filterindex]=uiputfile(filename,''Veuillez choisir un dossier'');uiresume(main)','BackgroundColor',[1 1 1]);
    uiwait(main);
    while filterindex~=1
        uicontrol('Parent',main,'Style','text','Position',[0.25*lg 80 150 25],'String','Dossier d''enregistrement invalide','BackgroundColor',[1 1 1],'ForegroundColor',[1 0 0]);
        pause(tps);
        uicontrol('Parent',main,'Style','text','Position',[0.25*lg 80 150 25],'String','','BackgroundColor',[1 1 1]);
        [filename2,pathname2,filterindex]=uiputfile(filename,'Veuillez choisir un dossier');
    end
    cd(pathname2);
    %% Ecriture du fichier
    % Creation de la matrice contenant les bonnes donnees
    M2(:,1)=temps2;
    M2(:,2)=accxh;
    M2(:,3)=v;
    M2(:,4)=p;
    fid=fopen(filename2,'w');%ouverture du fichier
    entete={'Temps [s]','Acceleration [m.s^-2]','Vitesse [m.s^-1]','Position [m]'};
    fprintf(fid,'%s;%s;%s;%s\n',entete{:});%ecriture de l'en-tete
    for i=2:length(temps2)+1%ecriture des donnees
        fprintf(fid,'%.3f,%.3f,%.3f,%.3f\n',M2(i-1,:));
    end
    fclose(fid);%fermeture du fichier
    %% Reouvrir un fichier/Fermer le programme
    uicontrol('Parent',main,'Position',[0.25*lg 45 150 25],'String','Ouvrir un nouveau fichier','Callback','close all;uiresume(main);','BackgroundColor',[1 1 1]);
    uiwait(main);
end