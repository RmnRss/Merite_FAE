% Clear/close all
  clear all;
  close all;

% RECUPERATION & STOCKAGE DES DONNEES
  %% Données d'un fichier csv vers la matrice M
  M = csvread('LANCER_2.CSV',1,0);

  %% Stockage des différentes données dans des variables
  taille = length(M);
  temps = M(:,1);
  declenchement = 0;
  accx = M(:,2) * 9.81;   % Stockage des données de l'accélération selon X en m/s^2
  accy = M(:,3) * 9.81;   % Stockage des données de l'accélération selon Y en m/s^2
  accz = M(:,4) * 9.81;   % Stockage des données de l'accélération selon Z en m/s^2
  gyrox = M(:,5);
  gyroy = M(:,6);
  gyroz = M(:,7);
  alt_p = M(:,8);
    
% RECADRAGE TEMPOREL
  %% Detection du temps de lancement
  for i = 1:taille
    if declenchement == 0 && abs(accx(i))>30 && temps(i)>2
       declenchement = 1;
       ideclenchement = i-33;%33 car 33Hz de frequency rate
    end
  end
  
  %% Declaration fin de prise de donnee
  ifin = taille-2;%car probleme de zero a la fin
  
  %% Definition de la nouvelle taille de l'intervalle
  taille2 = ifin-ideclenchement+1;
  
  %% Preallocation 
  temps2 = zeros(1,taille2);
  accx2 = zeros(1,taille2);
  accy2 = zeros(1,taille2);
  accz2 = zeros(1,taille2);
  gyrox2 = zeros(1,taille2);
  gyroy2 = zeros(1,taille2);
  gyroz2 = zeros(1,taille2);
  
  for i = ideclenchement:ifin
    temps2(i-ideclenchement+1) = temps(i)-temps(ideclenchement);
    accx2(i-ideclenchement+1) = accx(i);
    accy2(i-ideclenchement+1) = accy(i);
    accz2(i-ideclenchement+1) = accz(i);
    gyrox2(i-ideclenchement+1) = gyrox(i);
    gyroy2(i-ideclenchement+1) = gyroy(i);
    gyroz2(i-ideclenchement+1) = gyroz(i);   
  end
  
% SUPPRESSION DE L'OFFSET
  %% Creation variable temps après 2 secondes pour le calcul offset
  for i = 1:taille
    if temps(i)>2
      temps2s = i;
      break
    end
  end
  
  %% Calcul de la moyenne acceleration
  moyaccx = 0;
  moyaccy = 0;
  moyaccz = 0;
    
  for i = 1:temps2s
    moyaccx = moyaccx+accx(i);
    moyaccy = moyaccy+accy(i);
    moyaccz = moyaccz+accz(i);
  end
    
  moyaccx = moyaccx/temps2s;
  moyaccy = moyaccy/temps2s;
  moyaccz = moyaccz/temps2s;
    
  %% Retranchement des moyennes
  ecart_x = 9.81-moyaccx;
  accx2 = accx2+ecart_x;
  accy2 = accy2-moyaccy;
  accz2 = accz2-moyaccz;
    
  %% Mise a 0 des variables y et z
  accx2(1) = 9.81;
  accy2(1) = 0;
  accz2(1) = 0;
  
  %% Calcul de la moyenne gyro
  gyroxmoy = 0;
  gyroymoy = 0;
  gyrozmoy = 0;
    
  for i = 1:temps2s
    gyroxmoy = gyroxmoy+gyrox(i);
    gyroymoy = gyroymoy+gyroy(i);
    gyrozmoy = gyrozmoy+gyroz(i);
  end
  
  gyroxmoy = gyroxmoy/temps2s;
  gyroymoy = gyroymoy/temps2s;
  gyrozmoy = gyrozmoy/temps2s;
  
  %% Retranchement des moyennes
  gyrox2 = gyrox2-gyroxmoy;
  gyroy2 = gyroy2-gyroymoy;
  gyroz2 = gyroz2-gyrozmoy;
  
  %% Mise a 0 des variables y et z
  gyrox2(1) = 0;
  gyroy2(1) = 0;
  gyroz2(1) = 0;
  
% LISSAGE DE LA COURBE
  for i = 1:taille2-1
    if abs(accx2(i)-accx2(i+1))<5
      accx2(i+1) = accx2(i);
    end
    if abs(accy2(i)-accy2(i+1))<5
       accy2(i+1) = accy2(i);
    end
    if abs(accz2(i)-accz2(i+1))<5
       accz2(i+1) = accz2(i);
    end
    if abs(gyrox2(i)-gyrox2(i+1))<1
      gyrox2(i+1) = gyrox2(i);
    end
    if abs(gyroy2(i)-gyroy2(i+1))<1
      gyroy2(i+1) = gyroy2(i);
    end
    if abs(gyroz2(i)-gyroz2(i+1))<1
      gyroz2(i+1) = gyroz2(i);
    end
  end

% INTEGRATION VITESSE ANGULAIRE
  angley2 = zeros(1,taille2);
  angley2(1) = 0;
  
  for i = 2:taille2
    angley2(i) = angley2(i-1)+(temps2(i)-temps2(i-1))*(gyroy2(i)+gyroy2(i-1))/2;  
  end
  
  anglez2 = zeros(1,taille2);
  anglez2(1) = 0;

  for i = 2:taille2
    anglez2(i) = anglez2(i-1)+(temps2(i)-temps2(i-1))*(gyroz2(i)+gyroz2(i-1))/2;
  end
  
  anglex2 = zeros(1,taille2);
  anglex2(1) = 0;
  
  for i = 2:taille2
    anglex2(i) = anglex2(i-1)+(temps2(i)-temps2(i-1))*(gyrox2(i)+gyrox2(i-1))/2;
  end
  
% PROJECTION SUR L'AXE PRINCIPAL
  A = cosd(angley2);
  B = -sind(angley2);
  C = cosd(anglex2);
  D = -sind(anglex2);
  E = cosd(anglez2);
  F = sind(anglez2);
  accxh = (B.*D.*E+A.*F).*(-(accy2))+(-B.*D.*F+A.*E).*((-accx2))+(-B.*C).*((accz2))+9.81;
  accxh(1) = 0;  
  
% LISSAGE DE ACCELERATION EN H  
  for i = 1:taille2-1
    if abs(accxh(i)-accxh(i+1))<0.5
      accxh(i+1) = accxh(i);
    end
  end
  
% INTEGRATION DE A L'CCELERATION EN H
  v = zeros(1,taille2);
  v(1) = 0;
  
  for i = 2:taille2
    v(i) = v(i-1)+(temps2(i)-temps2(i-1))*(accxh(i)+accxh(i-1))/2;
  end
  
  %% Integration trapeze pour la position
  p = zeros(1,taille2);
  p(1) = 0;
   
  for i = 2:taille2
    p(i) = p(i-1)+(temps2(i)-temps2(i-1))*(v(i)+v(i-1))/2;
  end
    
% AFFICHAGE COURBE
maxp=max(p)
figure(1);
plot(temps2, accxh);
figure(2);
plot(temps2, v);
figure(3);
plot(temps2, p);